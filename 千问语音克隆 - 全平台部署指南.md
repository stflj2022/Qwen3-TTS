# 千问语音克隆 - 全平台部署指南

> 适用于 Windows / Linux / macOS 的详细部署说明

---

## 目录

1. [系统要求](#系统要求)
2. [安装 Python](#安装-python)
3. [部署方式](#部署方式)
4. [常见问题](#常见问题)

---

## 系统要求

| 组件 | 最低要求 | 推荐配置 |
|------|---------|---------|
| **操作系统** | Windows 10+ / Ubuntu 20.04+ / macOS 11+ | 最新版本 |
| **Python** | 3.10 | 3.11 或 3.12 |
| **内存** | 8GB | 16GB+ |
| **硬盘空间** | 13GB 可用空间 | 15GB+ SSD |
| **处理器** | 双核 CPU | 四核+ CPU |
| **显卡（可选）** | 无 | NVIDIA GPU (支持 CUDA) |
| **系统依赖** | ffmpeg（音频格式转换） | - |

---

## 安装系统依赖

### ffmpeg（必需）

用于音频格式转换（MP3/M4A/FLAC/Opus）。

#### Windows

```cmd
# 使用 Chocolatey
choco install ffmpeg

# 或从官网下载
# https://ffmpeg.org/download.html
```

#### Linux

```bash
# Ubuntu/Debian
sudo apt install ffmpeg -y

# CentOS/RHEL/Fedora
sudo dnf install ffmpeg -y

# Arch Linux
sudo pacman -S ffmpeg
```

#### macOS

```bash
brew install ffmpeg
```

---

## 安装 Python

### Windows 系统

#### 方法一：官网安装（推荐）

1. 访问 Python 官网：https://www.python.org/downloads/

2. 下载 Python 3.10 或更高版本（推荐 3.11）

3. 运行安装程序，**务必勾选**：
   - ✅ `Add Python to PATH`

4. 安装完成后，打开命令提示符（CMD）验证：
   ```cmd
   python --version
   ```

#### 方法二：微软商店安装

1. 打开 Microsoft Store
2. 搜索 "Python 3.11" 或 "Python 3.12"
3. 点击安装

---

### Linux 系统

#### Ubuntu / Debian / Linux Mint

```bash
# 更新软件包列表
sudo apt update

# 安装 Python 和虚拟环境工具
sudo apt install python3 python3-venv python3-pip -y

# 验证安装
python3 --version
```

#### CentOS / RHEL / Fedora

```bash
# CentOS/RHEL
sudo yum install python3 python3-venv -y

# Fedora
sudo dnf install python3 python3-venv -y

# 验证安装
python3 --version
```

#### Arch Linux

```bash
sudo pacman -S python python-pip
```

---

### macOS 系统

#### 方法一：使用 Homebrew（推荐）

```bash
# 安装 Homebrew（如果尚未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装 Python
brew install python@3.11

# 验证安装
python3 --version
```

#### 方法二：官网安装

1. 访问 https://www.python.org/downloads/macos/

2. 下载 macOS 安装包（pkg 格式）

3. 双击安装，按提示完成

---

## 部署方式

### 方式一：自动部署（推荐）

适用于所有平台，双击运行即可。

#### Windows

1. 双击运行 `启动WebUI.bat`
2. 等待自动安装依赖（首次运行约 5-15 分钟）
3. 浏览器自动打开 http://localhost:7860

#### Linux / macOS

```bash
# 添加执行权限
chmod +x 启动WebUI.sh

# 运行启动脚本
./启动WebUI.sh
```

启动脚本会自动检测并显示三个模型的安装状态：
- ✅ CustomVoice（预置音色）- 4.3GB - 内置
- ✅ Base（声音克隆）- 4.3GB - 内置
- ✅ VoiceDesign（声音设计）- 3.6GB - 内置

> **注意**：启动脚本会自动清除代理设置以避免 WebUI 启动错误。如需使用代理下载模型，请编辑 `download_*.py` 脚本。

**目录结构说明**：
```
千问语音克隆/
├── models/                 # CustomVoice 预置音色 (4.3GB)
├── models-base/            # Base 声音克隆 (4.3GB)
├── models-voicedesign/     # VoiceDesign 声音设计 (3.6GB)
├── cloned_voices/          # 保存的克隆音色（运行时自动创建）
├── outputs/                # 生成的音频文件
├── memory_manager.py       # 内存管理系统
├── voice_optimizer.py      # 音色优化系统
└── venv/                   # 虚拟环境（首次运行时创建）
```

---

### 方式二：手动部署

适用于需要自定义配置的用户。

#### 步骤 1：打开终端/命令行

- **Windows**: 按 `Win + R`，输入 `cmd`，回车
- **Linux**: 按 `Ctrl + Alt + T`
- **macOS**: 打开「终端」应用

#### 步骤 2：进入项目目录

```bash
# Windows (CMD)
cd /d "C:\路径\到\千问语音克隆"

# Windows (PowerShell)
cd "C:\路径\到\千问语音克隆"

# Linux / macOS
cd ~/千问语音克隆
# 或
cd /path/to/千问语音克隆
```

#### 步骤 3：创建虚拟环境

```bash
# Windows
python -m venv venv

# Linux / macOS
python3 -m venv venv
```

#### 步骤 4：激活虚拟环境

```bash
# Windows (CMD)
venv\Scripts\activate

# Windows (PowerShell)
venv\Scripts\Activate.ps1

# Linux / macOS
source venv/bin/activate
```

激活后，命令行前缀会显示 `(venv)`

#### 步骤 5：安装依赖

```bash
pip install -r requirements.txt
```

等待安装完成，可能需要 5-15 分钟。

#### 步骤 6：启动 WebUI

```bash
python webui.py
```

---

### 方式三：Docker 部署（高级用户）

#### 创建 Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    libsndfile1 \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# 复制项目文件
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

# 暴露端口
EXPOSE 7860

# 启动命令
CMD ["python", "webui.py", "--host", "0.0.0.0"]
```

#### 构建并运行

```bash
# 构建镜像
docker build -t qwen-tts .

# 运行容器
docker run -p 7860:7860 -v $(pwd)/outputs:/app/outputs qwen-tts
```

---

## GPU 加速配置（可选）

如有 NVIDIA 显卡，可大幅提升生成速度。

### 1. 安装 NVIDIA 驱动

- **Windows**: 从 https://www.nvidia.com/Download/index.aspx 下载安装
- **Linux**: `sudo apt install nvidia-driver-535`
- **macOS**: 不支持 NVIDIA GPU，请使用 CPU

### 2. 安装 CUDA 版本的 PyTorch

```bash
# 卸载 CPU 版本
pip uninstall torch torchaudio

# 安装 GPU 版本（CUDA 12.1）
pip install torch torchaudio --index-url https://download.pytorch.org/whl/cu121
```

### 3. 修改配置

编辑 `webui.py`，找到以下行：

```python
device_map="cpu",  # 改为 device_map="cuda:0"
```

修改为：

```python
device_map="cuda:0",
```

---

## 网络配置

### 局域网访问

默认配置已支持局域网访问，其他设备可通过以下地址访问：

```
http://<你的电脑IP>:7860
```

**查看 IP 地址：**

```bash
# Windows
ipconfig

# Linux
ip addr show

# macOS
ifconfig
```

### 公网访问

编辑启动脚本，添加 `--share` 参数：

```bash
python webui.py --share
```

这将生成一个临时公网链接，可通过互联网访问。

**注意**：公网链接有流量限制和时效限制，不适合长期使用。

---

## 常见问题

### Q1: 提示 "python 不是内部或外部命令"

**原因**: Python 未安装或未添加到 PATH

**解决**:
1. 重新安装 Python，确保勾选 "Add Python to PATH"
2. 或手动添加 Python 到系统 PATH 环境变量

### Q2: 虚拟环境创建失败

**原因**: 未安装 python3-venv

**解决**:
```bash
# Ubuntu/Debian
sudo apt install python3-venv

# CentOS/RHEL
sudo yum install python3-venv

# macOS
brew install python@3.11
```

### Q3: pip 安装依赖很慢或失败

**解决**: 使用国内镜像源

```bash
# 临时使用
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 永久配置
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

### Q4: 启动后浏览器没有自动打开

**解决**:
1. 手动打开浏览器
2. 访问 http://localhost:7860
3. 或检查防火墙设置

### Q5: 端口 7860 被占用

**解决**:

```bash
# 查看占用进程
lsof -i :7860

# 停止占用进程
kill <PID>

# 或修改端口号
python webui.py --port 8080
```

### Q6: 生成速度很慢

**原因**: 默认使用 CPU 运行

**解决**:
1. 使用 GPU 加速（见上文 GPU 配置）
2. 减少生成文本长度
3. 关闭其他占用 CPU 的程序

### Q7: 提示 "模型文件不存在" 或 "模型文件损坏"

**原因**: models 文件夹缺失、路径不正确或下载不完整

**解决**:
1. 确保三个模型文件夹都在程序目录下：
   - `models/` (CustomVoice - 约 4.3GB)
   - `models-base/` (Base - 约 4.3GB)
   - `models-voicedesign/` (VoiceDesign - 约 3.6GB)
2. 检查 model.safetensors 文件完整性
3. 如文件损坏，重新运行对应的 `download_*.py` 脚本

### Q8: Windows 提示 "无法加载 venv\Scripts\activate"

**原因**: PowerShell 执行策略限制

**解决**:
```powershell
# 临时允许执行
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process

# 然后重新激活
venv\Scripts\Activate.ps1
```

或使用 CMD 而不是 PowerShell。

### Q9: macOS 提示 "来自身份不明开发者"

**解决**:
```bash
# 允许运行启动脚本
xattr -cr 启动WebUI.sh
```

### Q10: 内存不足

**解决**:
1. 关闭其他程序
2. 使用较小的 batch size
3. 增加系统虚拟内存/交换空间

Linux 增加交换空间示例：
```bash
# 创建 15GB 交换文件
sudo fallocate -l 15G /swapfile
sudo chmod 600 /swapfile
sudo swapon /swapfile
```

### Q11: 批量生成支持哪些格式？

**支持的输出格式**：
- **WAV** - 无损，文件大，适合编辑
- **Opus** - 有损压缩，文件小，适合分享

### Q12: 如何制作有声书？

**步骤**：
1. 准备文本文件（建议每章单独一个文件，每章不超过 10 万字）
2. 在「批量生成」页面上传 .txt 文件
3. 选择输出格式（推荐 Opus 以节省空间）
4. 输入作品名称（用于文件命名）
5. 点击「批量生成」
6. 生成的音频会显示在右侧「生成的音频」框中

**文件命名规则**：`作品名称_001.opus`、`作品名称_002.opus` ...

### Q13: ffmpeg 相关错误

**错误提示**：`ffmpeg not found` 或 `sox not found`

**解决**：
- sox 警告可忽略（程序优先使用 ffmpeg）
- 如需 Opus 等格式，请安装 ffmpeg（见上文「安装系统依赖」）

### Q14: 批量生成的音频不显示

**问题描述**：批量生成完成后，右侧「生成的音频」框为空白

**解决**：
- 已在最新版本修复（2026-01-26）
- 请确保使用最新版本的 `webui.py`
- 音频文件仍会保存在 `outputs` 文件夹中

---

## 卸载

### Windows

```cmd
# 删除虚拟环境
rmdir /s venv

# 删除整个项目文件夹
rmdir /s "千问语音克隆"
```

### Linux / macOS

```bash
# 删除虚拟环境
rm -rf venv

# 删除整个项目文件夹
rm -rf 千问语音克隆
```

---

## 更新

### 获取更新版本

1. 下载新版本包
2. 备份 `outputs` 和 `cloned_voices` 文件夹（如有重要内容）
3. 替换所有文件，保留 `models` 文件夹
4. 重新运行启动脚本

### 更新依赖包

```bash
# 激活虚拟环境
source venv/bin/activate  # Linux/macOS
# 或 venv\Scripts\activate  # Windows

# 更新依赖
pip install --upgrade -r requirements.txt
```

---

## 技术支持

- **GitHub Issues**: https://github.com/QwenLM/Qwen3-TTS/issues
- **官方文档**: https://huggingface.co/Qwen/Qwen3-TTS-12Hz-1.7B-CustomVoice

---

**文档版本**: 1.4 | **更新日期**: 2026-01-26

---

## 更新日志

### v1.4 (2026-01-26)
- 修复批量生成页面音频显示问题
- 优化内存管理系统
- 改进音色优化系统

### v1.3 (2026-01-25)
- 初始版本
